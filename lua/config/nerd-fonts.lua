-- Script para baixar e instalar Nerd Fonts automaticamente
local M = {}

-- Fun√ß√£o para verificar se uma fonte est√° instalada (otimizada)
local function is_font_installed(font_name)
  local handle = io.popen("fc-list | grep -qi '" .. font_name .. "' && echo '1' || echo '0'")
  local result = handle:read("*a")
  handle:close()
  return result and result:match("1")
end

-- Fun√ß√£o para listar todas as fontes instaladas
local function list_installed_fonts()
  print("\nüîç Fontes monospace instaladas no sistema:")
  local handle = io.popen("fc-list :mono | grep -E '(JetBrains|Fira|Noto|Font|Hack|Source)' | cut -d: -f2 | sort | uniq")
  local result = handle:read("*a")
  handle:close()
  
  if result and result ~= "" then
    for line in result:gmatch("[^\r\n]+") do
      if line and line:gsub("%s+", "") ~= "" then
        print("  ‚úì " .. line:gsub("^%s+", ""):gsub("%s+$", ""))
      end
    end
  else
    print("  ‚ùå Nenhuma fonte monospace encontrada")
  end
end

-- Fun√ß√£o para baixar e instalar uma fonte (m√©todo otimizado via wget)
local function install_font(font_name, font_url)
  local fonts_dir = os.getenv("HOME") .. "/.local/share/fonts"
  
  -- Criar diret√≥rio se n√£o existir
  os.execute("mkdir -p " .. fonts_dir .. " 2>/dev/null")
  
  print("üì¶ Instalando " .. font_name .. "...")
  
  -- M√©todo otimizado: download direto, extra√ß√£o e limpeza em uma linha
  local install_cmd = string.format(
    "wget -P %s %s && cd %s && unzip -qq %s.zip && rm %s.zip && fc-cache -fv > /dev/null 2>&1",
    fonts_dir, font_url, fonts_dir, font_name, font_name
  )
  
  if os.execute(install_cmd) == 0 then
    print("‚úì " .. font_name .. " instalada!")
    return true
  else
    print("‚úó Erro ao instalar " .. font_name)
    return false
  end
end

-- Fun√ß√£o para atualizar cache de fontes
local function update_font_cache()
  print("Atualizando cache de fontes...")
  os.execute("fc-cache -fv ~/.local/share/fonts > /dev/null 2>&1")
  print("‚úì Cache de fontes atualizado!")
end

-- Fun√ß√£o para detectar o gerenciador de pacotes
local function detect_package_manager()
  local managers = {
    { cmd = "dnf", distro = "fedora" },
    { cmd = "apt", distro = "ubuntu" },
    { cmd = "yum", distro = "rhel" },
    { cmd = "pacman", distro = "arch" },
    { cmd = "zypper", distro = "opensuse" }
  }
  
  for _, manager in ipairs(managers) do
    local handle = io.popen("command -v " .. manager.cmd .. " 2>/dev/null")
    local result = handle:read("*a")
    handle:close()
    
    if result and result ~= "" then
      return manager.cmd, manager.distro
    end
  end
  
  return nil, "unknown"
end

-- Fun√ß√£o para verificar se um pacote est√° instalado via DNF
local function is_package_installed_dnf(package_name)
  local handle = io.popen("dnf list installed " .. package_name .. " 2>/dev/null | grep -c '" .. package_name .. "'")
  local result = handle:read("*a")
  handle:close()
  return tonumber(result) > 0
end

-- Fun√ß√£o para verificar se um pacote est√° instalado via APT
local function is_package_installed_apt(package_name)
  local handle = io.popen("dpkg -l " .. package_name .. " 2>/dev/null | grep -c '^ii'")
  local result = handle:read("*a")
  handle:close()
  return tonumber(result) > 0
end

-- Fun√ß√£o para verificar se pacotes est√£o instalados baseado no sistema
local function are_font_packages_installed()
  local package_manager, distro = detect_package_manager()
  
  local font_packages = {}
  if package_manager == "dnf" then
    font_packages = {
      "jetbrains-mono-fonts",
      "fira-code-fonts", 
      "google-noto-emoji-fonts",
      "fontawesome-fonts",
      "powerline-fonts"
    }
  elseif package_manager == "apt" then
    font_packages = {
      "fonts-jetbrains-mono",
      "fonts-firacode",
      "fonts-noto-emoji",
      "fonts-fontawesome",
      "fonts-powerline"
    }
  else
    return false -- Para outros sistemas, usar verifica√ß√£o de fonte
  end
  
  local installed_count = 0
  for _, package in ipairs(font_packages) do
    if package_manager == "dnf" and is_package_installed_dnf(package) then
      installed_count = installed_count + 1
    elseif package_manager == "apt" and is_package_installed_apt(package) then
      installed_count = installed_count + 1
    end
  end
  
  -- Se pelo menos 3 dos 5 pacotes est√£o instalados, considerar como j√° instalado
  return installed_count >= 3
end

-- Fun√ß√£o para instalar via DNF (Fedora/RHEL)
local function install_fonts_fedora()
  print("üîß Instalando fontes via DNF...")
  
  local fonts_to_install = {
    "jetbrains-mono-fonts",
    "fira-code-fonts", 
    "google-noto-emoji-fonts",
    "fontawesome-fonts",
    "powerline-fonts"
  }
  
  for _, font_package in ipairs(fonts_to_install) do
    print("üì¶ Instalando " .. font_package .. "...")
    local cmd = "sudo dnf install -y " .. font_package .. " 2>/dev/null || echo 'Pacote n√£o encontrado: " .. font_package .. "'"
    os.execute(cmd)
  end
  
  return true
end

-- Fun√ß√£o para instalar via APT (Ubuntu/Debian)
local function install_fonts_ubuntu()
  print("üîß Instalando fontes via APT...")
  
  -- Primeiro, atualizar a lista de pacotes
  print("üì¶ Atualizando lista de pacotes...")
  os.execute("sudo apt update -qq 2>/dev/null")
  
  local fonts_to_install = {
    "fonts-jetbrains-mono",
    "fonts-firacode",
    "fonts-noto-emoji",
    "fonts-fontawesome",
    "fonts-powerline"
  }
  
  for _, font_package in ipairs(fonts_to_install) do
    print("üì¶ Instalando " .. font_package .. "...")
    local cmd = "sudo apt install -y " .. font_package .. " 2>/dev/null || echo 'Pacote n√£o encontrado: " .. font_package .. "'"
    os.execute(cmd)
  end
  
  return true
end

-- Fun√ß√£o para instalar via Pacman (Arch Linux)
local function install_fonts_arch()
  print("üîß Instalando fontes via Pacman...")
  
  local fonts_to_install = {
    "ttf-jetbrains-mono",
    "ttf-fira-code",
    "noto-fonts-emoji",
    "ttf-font-awesome",
    "powerline-fonts"
  }
  
  for _, font_package in ipairs(fonts_to_install) do
    print("üì¶ Instalando " .. font_package .. "...")
    local cmd = "sudo pacman -S --noconfirm " .. font_package .. " 2>/dev/null || echo 'Pacote n√£o encontrado: " .. font_package .. "'"
    os.execute(cmd)
  end
  
  return true
end

-- Fun√ß√£o para instalar fontes baseada no sistema
local function install_fonts_system()
  local package_manager, distro = detect_package_manager()
  
  print("üîç Sistema detectado: " .. (distro or "desconhecido"))
  print("üì¶ Gerenciador de pacotes: " .. (package_manager or "n√£o encontrado"))
  
  if package_manager == "dnf" then
    return install_fonts_fedora()
  elseif package_manager == "apt" then
    return install_fonts_ubuntu()
  elseif package_manager == "pacman" then
    return install_fonts_arch()
  elseif package_manager == "yum" then
    -- Para RHEL/CentOS mais antigos, usar yum com pacotes similares ao DNF
    print("üîß Instalando fontes via YUM...")
    local fonts_to_install = {
      "google-noto-emoji-fonts",
      "fontawesome-fonts",
    }
    
    for _, font_package in ipairs(fonts_to_install) do
      print("üì¶ Instalando " .. font_package .. "...")
      local cmd = "sudo yum install -y " .. font_package .. " 2>/dev/null || echo 'Pacote n√£o encontrado: " .. font_package .. "'"
      os.execute(cmd)
    end
    return true
  else
    print("‚ö†Ô∏è  Gerenciador de pacotes n√£o suportado, tentando download direto...")
    return false
  end
end

-- Lista de fontes essenciais para LazyVim (URLs espec√≠ficas v3.0.2)
local fonts = {
  {
    name = "JetBrainsMono",
    url = "https://github.com/ryanoasis/nerd-fonts/releases/download/v3.0.2/JetBrainsMono.zip"
  },
  {
    name = "FiraCode", 
    url = "https://github.com/ryanoasis/nerd-fonts/releases/download/v3.0.2/FiraCode.zip"
  },
  {
    name = "Hack",
    url = "https://github.com/ryanoasis/nerd-fonts/releases/download/v3.0.2/Hack.zip"
  }
}

-- Fun√ß√£o principal para instalar todas as fontes necess√°rias
function M.setup()
  print("üîç Verificando Nerd Fonts...")
  
  -- Primeiro verificar se os pacotes j√° est√£o instalados
  if are_font_packages_installed() then
    print("‚úÖ Fontes j√° instaladas via gerenciador de pacotes!")
    list_installed_fonts()
    return
  end
  
  -- Verificar se as fontes b√°sicas est√£o instaladas
  local basic_fonts_missing = false
  local basic_fonts = {"JetBrains", "Fira", "Noto"}
  
  for _, font in ipairs(basic_fonts) do
    if not is_font_installed(font) then
      basic_fonts_missing = true
      break
    end
  end
  
  if basic_fonts_missing then
    print("üì¶ Instalando fontes via reposit√≥rio do sistema...")
    local system_success = install_fonts_system()
    
    if not system_success then
      print("üöÄ Tentando instalar Nerd Fonts via download...")
      for _, font in ipairs(fonts) do
        install_font(font.name, font.url)
      end
    end
    
    update_font_cache()
    
    print("\nüéâ Fontes instaladas! Reinicie seu terminal e configure para usar:")
    print("   - JetBrains Mono")
    print("   - Fira Code") 
    print("   - Noto Emoji")
    print("\nPara configurar no terminal:")
    print("   GNOME Terminal: Prefer√™ncias > Perfis > Fonte")
    print("   Terminal (Ubuntu): Prefer√™ncias > Fonte")
    print("   Konsole (KDE): Configura√ß√µes > Editar perfil > Apar√™ncia > Fonte")
  else
    print("‚úÖ Fontes b√°sicas j√° encontradas no sistema!")
    list_installed_fonts()
  end
end

-- Auto-executar na primeira vez (otimizado para evitar tela preta)
function M.auto_setup()
  -- Verifica√ß√£o r√°pida: se tem JetBrains ou Fira, j√° est√° bom
  if is_font_installed("JetBrains") or is_font_installed("Fira") then
    return -- Sai silenciosamente se j√° tem fontes
  end
  
  -- Verifica√ß√£o de pacotes apenas se n√£o tem fontes b√°sicas
  if are_font_packages_installed() then
    return -- Sai silenciosamente se pacotes est√£o instalados
  end
  
  -- S√≥ mostra mensagem se realmente vai instalar
  print("üöÄ Instalando fontes essenciais...")
  
  -- Instalar apenas JetBrains Mono (mais r√°pido)
  local jetbrains_url = "https://github.com/ryanoasis/nerd-fonts/releases/download/v3.0.2/JetBrainsMono.zip"
  if install_font("JetBrainsMono", jetbrains_url) then
    print("‚úÖ Fonte instalada! Configure seu terminal para usar JetBrains Mono")
  else
    -- Fallback para m√©todo do sistema
    install_fonts_system()
  end
end

-- Expor a fun√ß√£o list_installed_fonts
function M.list_installed_fonts()
  list_installed_fonts()
end

return M