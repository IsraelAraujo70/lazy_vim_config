# OpenCode Integration for Neovim

Esta integra√ß√£o permite que o [OpenCode](https://opencode.ai) envie diffs diretamente para o Neovim, proporcionando uma experi√™ncia visual rica para revisar e aplicar mudan√ßas de c√≥digo.

## üöÄ Funcionalidades

- **Visualiza√ß√£o side-by-side** de diffs com highlighting sint√°tico
- **Descoberta autom√°tica de porta** - suporta m√∫ltiplas inst√¢ncias do Neovim
- **Health check endpoint** para verifica√ß√£o de inst√¢ncias ativas
- **Configura√ß√£o autom√°tica** do opencode.json
- **Sincroniza√ß√£o de scroll** entre pain√©is
- **Keymaps personaliz√°veis** para aceitar/rejeitar mudan√ßas

## üì¶ Instala√ß√£o

A integra√ß√£o j√° est√° configurada nesta config do Neovim. Os arquivos incluem:

```
lua/
‚îú‚îÄ‚îÄ opencode-diff/
‚îÇ   ‚îú‚îÄ‚îÄ init.lua          # M√≥dulo principal
‚îÇ   ‚îî‚îÄ‚îÄ install.lua       # Gerenciamento do bridge script
‚îî‚îÄ‚îÄ plugins/
    ‚îî‚îÄ‚îÄ opencode-diff.lua # Configura√ß√£o do plugin
```

## üîß Configura√ß√£o

### 1. Instalar o Bridge Script

```vim
:OpenCodeInstallBridge
```

Isso instala o script `nvim-opencode-bridge` em `~/.local/bin/` (ou outro diret√≥rio apropriado).

### 2. Verificar Instala√ß√£o

```vim
:OpenCodeStatus
```

### 3. Configura√ß√£o Autom√°tica

O plugin configura automaticamente o `opencode.json` no diret√≥rio do projeto com os hooks necess√°rios:

```json
{
  "experimental": {
    "hook": {
      "file_edited": {
        ".lua": [{
          "command": ["nvim-opencode-bridge"],
          "environment": {
            "OPENCODE_FILE": "$FILE",
            "OPENCODE_ACTION": "edited"
          }
        }],
        ".ts": [{ /* ... */ }],
        ".js": [{ /* ... */ }]
        // ... outras extens√µes
      }
    }
  }
}
```

## üéØ Como Usar

### 1. Iniciar o Neovim
O servidor HTTP inicia automaticamente e encontra uma porta dispon√≠vel (38600+).

### 2. Usar o OpenCode
Execute comandos normalmente no opencode:
```bash
opencode "fix this function"
opencode "add error handling to this code"
```

### 3. Visualizar Diffs
Quando o opencode fizer mudan√ßas, uma nova aba ser√° aberta automaticamente mostrando:
- **Painel esquerdo**: C√≥digo original
- **Painel direito**: C√≥digo modificado
- **Highlighting**: Linhas adicionadas (verde), removidas (vermelho), modificadas (amarelo)

### 4. Aceitar/Rejeitar Mudan√ßas
- `<leader>oa` - Aceitar mudan√ßas
- `<leader>or` - Rejeitar mudan√ßas  
- `<leader>od` - Mostrar diff atual
- `q` ou `<Esc>` - Fechar visualiza√ß√£o

## üîß Comandos Dispon√≠veis

| Comando | Descri√ß√£o |
|---------|-----------|
| `:OpenCode <prompt>` | Executar opencode com prompt |
| `:OpenCodeDiff` | Mostrar diff atual |
| `:OpenCodeAccept` | Aceitar mudan√ßas pendentes |
| `:OpenCodeReject` | Rejeitar mudan√ßas pendentes |
| `:OpenCodeStatus` | Mostrar status da integra√ß√£o |
| `:OpenCodeInstallBridge` | Instalar bridge script |
| `:OpenCodeCheckBridge` | Verificar instala√ß√£o do bridge |
| `:OpenCodeUninstallBridge` | Desinstalar bridge script |

## ‚öôÔ∏è Configura√ß√£o Personalizada

Voc√™ pode personalizar a integra√ß√£o editando `lua/plugins/opencode-diff.lua`:

```lua
require("opencode-diff").setup({
  -- Porta base (ser√° encontrada automaticamente)
  server_port_base = 38600,
  
  -- Configura√ß√£o autom√°tica do opencode.json
  auto_setup_hooks = true,
  
  -- Keymaps personalizados
  keymaps = {
    accept = "<leader>oa",
    reject = "<leader>or", 
    show_diff = "<leader>od",
  },
  
  -- Op√ß√µes de diff
  diff_options = {
    algorithm = "github",
    context = 3,
    full_context = true,
    ignore_whitespace = false,
    word_diff = true,
  },
})
```

## üîç Descoberta Din√¢mica de Porta

O sistema usa m√∫ltiplos m√©todos para encontrar inst√¢ncias ativas do Neovim:

1. **Arquivos de porta**: `/tmp/opencode-diff/nvim-port-*`
2. **Health checks**: Testa conectividade HTTP
3. **Scan de portas**: Verifica ranges comuns (38600-38700)
4. **Compatibilidade**: Suporta inst√¢ncias claude-diff existentes

## üêõ Troubleshooting

### Bridge Script N√£o Encontrado
```vim
:OpenCodeInstallBridge
```

### Porta N√£o Dispon√≠vel
O sistema encontra automaticamente uma porta livre. Verifique com:
```vim
:OpenCodeStatus
```

### OpenCode N√£o Conecta
1. Verifique se o bridge est√° no PATH:
   ```bash
   which nvim-opencode-bridge
   ```

2. Teste manualmente:
   ```bash
   echo '{"filename":"test.txt","new_content":"hello","action":"edited"}' | \
   curl -X POST -H "Content-Type: application/json" -d @- http://localhost:38600/diff
   ```

### M√∫ltiplas Inst√¢ncias
Cada inst√¢ncia do Neovim usa uma porta diferente automaticamente. O bridge encontra a inst√¢ncia correta baseada no diret√≥rio de trabalho.

## üîÑ Diferen√ßas do Claude Code

| Aspecto | Claude Code | OpenCode |
|---------|-------------|----------|
| **Config** | `.claude/settings.json` | `opencode.json` |
| **Hooks** | `PostToolUse` | `file_edited` |
| **Trigger** | Tool matcher | Por extens√£o |
| **Porta** | Fixa (38500) | Din√¢mica (38600+) |
| **Bridge** | `nvim-claude-bridge` | `nvim-opencode-bridge` |

## üìù Logs e Debug

Para debug, verifique:
- Logs do Neovim: `:messages`
- Status do servidor: `:OpenCodeStatus`
- Teste do bridge: Execute manualmente o script

## ü§ù Compatibilidade

- ‚úÖ Funciona junto com claude-diff (portas diferentes)
- ‚úÖ Suporta m√∫ltiplas inst√¢ncias do Neovim
- ‚úÖ Compat√≠vel com todos os LLM providers do opencode
- ‚úÖ Funciona em Linux, macOS e WSL